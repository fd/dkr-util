build:
  box: golang
  steps:
  - setup-go-workspace

  - script:
      name: "go install"
      code: |
        CGO_ENABLED=0 go install -v ./cmd/...

  - script:
      name: "go test"
      code: |
        go test -v ./cmd/... ./pkg/...

  - script:
      name: "go build"
      code: |
        mkdir -p ${WERCKER_OUTPUT_DIR}/dist
        CGO_ENABLED=0 GOOS=linux  GOARCH=amd64 go build -o ${WERCKER_OUTPUT_DIR}/bin/dkr-linux-amd64/dkr  ./cmd/dkr
        CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o ${WERCKER_OUTPUT_DIR}/bin/dkr-darwin-amd64/dkr ./cmd/dkr
        tar -C ${WERCKER_OUTPUT_DIR}/bin/dkr-linux-amd64  -f ${WERCKER_OUTPUT_DIR}/dist/dkr-linux-amd64.tar.gz  -cz .
        tar -C ${WERCKER_OUTPUT_DIR}/bin/dkr-darwin-amd64 -f ${WERCKER_OUTPUT_DIR}/dist/dkr-darwin-amd64.tar.gz -cz .

deploy:
  box: golang
  steps:
  - script:
      name: "Get unzip"
      code: |
        apt-get update -y
        apt-get install -y unzip
  - script:
      name: "Get ghr"
      code: |
        curl -O -L https://github.com/tcnksm/ghr/releases/download/pre-release/linux_amd64.zip
        unzip -p linux_amd64.zip ghr > /usr/local/bin/ghr
        chmod a+x /usr/local/bin/ghr
  - script:
      name: "Push release"
      code: |
        if [[ "$WERCKER_DEPLOYTARGET_NAME" == "prerelease" ]]; then
          TAG="$(echo "$WERCKER_GIT_COMMIT" | cut -c 1-7)"
          ghr -u fd -r dkr-util -c $WERCKER_GIT_COMMIT --replace --prerelease "v1.0.0-pre+c.${TAG}" ./dist
        else
          TAG="$(echo "$WERCKER_GIT_COMMIT" | cut -c 1-7)"
          ghr -u fd -r dkr-util -c $WERCKER_GIT_COMMIT --replace "v1.0.0+c.${TAG}" ./dist
        fi
        steps:
  - mbrevda/wercker-triggerbuild@0.0.10:
      token: $WRK_TOKEN
      applicaiton_id: $WRK_APP
      message: Triggered from dkr
